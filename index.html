<html>

<head>
    <script src="p5.js"></script>
    <script src="sound.js"></script>
</head>

<body>
    <h1>Live Detector</h1>
    <button onclick="startaudio()">Start</button>
    <button onclick="nextonedownload()">start record</button>
    <button onclick="nextonestop()">stop record</button>
    <div id="outputarea"></div>

    <script>
        let mic, fft, peakDetect, amplitude;

        var finalspectrumlist = '';
        var nowamp, locallowamp = 0,
            localhighamp = 0,
            oldamp;
        var myframe = [];
        var myframelength = 20;
        var myframetotal = 0;
        var ampslope = 0;

        function setup() {
            createCanvas(710, 400);
            noFill();
            mic = new p5.AudioIn();
            mic.start();
            fft = new p5.FFT();
            fft.setInput(mic);
            // peakDetect = new p5.PeakDetect();
            amplitude = new p5.Amplitude();
            amplitude.setInput(mic)
            nowamp = 0;
        }

        function checksound() {
            let spectrum = fft.analyze();
            // peakDetect.update(fft);
            // if (peakDetect.isDetected) {
            //     console.count('peak')
            // } else {

            // }
            beginShape();

            let sortfreq = []
            for (i = 0; i < spectrum.length; i++) {
                const tempfreq = 1125 * Math.log(1 + spectrum[i] / 700)
                spectrum[i] = tempfreq
                const tempfreqjson = {
                    index: i,
                    value: tempfreq
                }
                sortfreq.push(tempfreqjson)
                vertex(i, map(spectrum[i], 0, 255, height, 0));
            }


            sortfreq.sort(function (x, y) {
                if (x.value > y.value)
                    return -1
                else if (x.value < y.value)
                    return 1
                else
                    return 0
            })

            // console.log(sortfreq)
            // console.log(spectrum)

            var finalfreq = [];
            for (var j = 0; j < sortfreq.length / 2; j++) {
                finalfreq.push(sortfreq[j].index)
            }

            console.log(finalfreq)

            // document.getElementById("outputarea").innerHTML = '';
            // for (var j=0; j<ans.length; j++){
            //     document.getElementById("outputarea").innerHTML += freqcountcpy[ans[j]] + '<br>';
            // }


            endShape();
        }


        function draw() {
            background(200);
            let level = amplitude.getLevel();
            let tempamp = map(level, 0, 1, 0, 70);
            myframe.push(tempamp)
            myframetotal += tempamp
            if (myframe.length > myframelength) {
                myframetotal -= myframe.shift()
            }
            nowamp = Math.round(myframetotal / myframelength);
            // console.log(nowamp)

            if (myframe.length == myframelength) {
                if (oldamp > nowamp) {
                    locallowamp = nowamp
                    if (ampslope == 0 || ampslope == 1) {
                        if (localhighamp - locallowamp > 3) {
                            checksound()
                        }
                    }
                    ampslope = -1
                } else if (oldamp < nowamp) {
                    localhighamp = nowamp
                    ampslope = 1
                } else {
                    ampslope = 0
                }
                oldamp = nowamp;
            }

            // checksound()

        }

        function download(filename, text) {
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
        }

        nextonedown = 0

        function nextonedownload() {
            nextonedown = 1

        }

        function nextonestop() {
            nextonedown = 0
            download('frequency.txt', finalspectrumlist)
        }

        function startaudio() {
            getAudioContext().resume()
        }
    </script>
</body>

</html>